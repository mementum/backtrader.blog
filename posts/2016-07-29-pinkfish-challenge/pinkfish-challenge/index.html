<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Pinkfish Challenge &mdash; backtrader  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
    <script type="text/javascript" src="../../../_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="top" title="backtrader  documentation" href="../../../" />
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.post-list-style-disc {list-style-type: disc;}
    ul.post-list-style-none {list-style-type: none;}
    ul.post-list-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="pinkfish-challenge">
<h1>Pinkfish Challenge<a class="headerlink" href="#pinkfish-challenge" title="Permalink to this headline">¶</a></h1>
<p>(Sample and changes added to release <code class="docutils literal"><span class="pre">1.7.1.93</span></code>)</p>
<p>Along the way <em>backtrader</em> has gotten maturity, new features and of course
complexity. Many of the new features have been introduced after requests,
comments, questions from users. Small challenges which have proven that most of
the design decisions were at least not that wrong even if some things could
have been done in many other ways, sometimes probably in a better way.</p>
<p>As such it seems that those small challenges are pushes to test the flexibility
and adaptability of the platform to new unplanned and unpexpected situations
and the <em>pinkfish</em> challenge is yet another one. <em>pinkfish</em> is another Python
backtesting framework (listed in the <code class="docutils literal"><span class="pre">README</span></code>) which can be found under:
<a class="reference external" href="http://fja05680.github.io/pinkfish/">pinkfish</a>. The site contains what has
been the challenge to solve:</p>
<blockquote>
<div><ul class="simple">
<li><em>&#8216;buying on the close&#8217; on the SAME day a &#8216;new 20 day high is set&#8217; were not
allowed</em></li>
</ul>
</div></blockquote>
<p>One of the <em>features</em> gives a hint as how the platform operates for such a
feat:</p>
<blockquote>
<div><ul class="simple">
<li><em>uses daily data (vs minute or tick data) for intraday trading</em></li>
</ul>
</div></blockquote>
<p>The author was additionally <em>put off</em> by the complexity of the, back then, of
the existing backtesting libraries. Whether that holds true for <em>backtrader</em>
(in its infancy back then) is a question to be answered by the <em>pinkfish</em>
author himself.</p>
<div class="section" id="no-mod-solution">
<h2>No mod solution<a class="headerlink" href="#no-mod-solution" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><em>backtrader</em> supports filters for data feeds and one existed that allows</dt>
<dd>breaking a <em>daily bar</em> in 2 parts to let people buy after having seen only the
opening price. The 2nd part of the day (high, low, close) is evaluated in a
2nd tick. This effectively achieves the <em>uses daily data (vs minute or tick
data) for intraday trading</em>.</dd>
</dl>
<p>This filter tries to make a complete <em>replay</em> action without involving the
built-in replayer.</p>
<p>An obvious evolution of this filter breaks the daily bar in 2 bars with an
(open, high, low) first and then a 2nd complete bar (open, high, low, close).</p>
<p>The <em>buying on the close</em> is achieved by issuing an order with
<code class="docutils literal"><span class="pre">backtrader.Order.Close</span></code> as execution type.</p>
<p>This is in the sample available with <code class="docutils literal"><span class="pre">-no-replay</span></code>. An execution:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./pinkfish-challenge.py --no-replay
</pre></div>
</div>
<p>Part of the output:</p>
<div class="highlight-python"><div class="highlight"><pre>...
0955,0478,0478,2006-11-22T00:00:00,27.51,28.56,27.29,28.49,16027900.00,0.00
High 28.56 &gt; Highest 28.56
LAST 19 highs: array(&#39;d&#39;, [25.33, 25.6, 26.4, 26.7, 26.62, 26.6, 26.7, 26.7, 27.15, 27.25, 27.65, 27.5, 27.62,   27.5, 27.5, 27.33, 27.05, 27.04, 27.34])
-- BUY on date: 2006-11-22
-- BUY Completed on: 2006-11-22
-- BUY Price: 28.49
0956,0478,0478,2006-11-22T23:59:59.999989,27.51,28.56,27.29,28.49,32055800.00,0.00
...
</pre></div>
</div>
<p>It works ...</p>
<blockquote>
<div><ul>
<li><p class="first">After seeing the 1st part of the day (Line: <code class="docutils literal"><span class="pre">0955</span></code>)</p>
</li>
<li><p class="first">If a new 20 day high is in place a <code class="docutils literal"><span class="pre">Close</span></code> order is issued</p>
</li>
<li><p class="first">And the order gets executed with the <em>closing</em> price of the 2nd part of the
day (Line: <code class="docutils literal"><span class="pre">0956</span></code>)</p>
<p>The closing price is <code class="docutils literal"><span class="pre">28.49</span></code> which is the <em>BUY Price</em> seen in
<code class="docutils literal"><span class="pre">notify_order</span></code> in the strategy</p>
</li>
</ul>
</div></blockquote>
<p>The output contains rather verbose parts simply for identification of the last
<code class="docutils literal"><span class="pre">20</span></code> highs. The sample sells also very quickly, to let the behavior be tested
several times. But the holding period can be altered with <code class="docutils literal"><span class="pre">--sellafter</span> <span class="pre">N</span></code>,
where <code class="docutils literal"><span class="pre">N</span></code> is the number of bars to hold before cancelling (see <em>Usage</em> at the
end)</p>
<div class="section" id="the-problem-with-the-no-mod-solution">
<h3>The problem with the <code class="docutils literal"><span class="pre">no</span> <span class="pre">mod</span></code> solution<a class="headerlink" href="#the-problem-with-the-no-mod-solution" title="Permalink to this headline">¶</a></h3>
<p>This is not really a <strong>replay</strong> solution and this can be seen if the <em>execution
type</em> of the order is changed from <code class="docutils literal"><span class="pre">Close</span></code> to <code class="docutils literal"><span class="pre">Market</span></code>. A new execution:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./pinkfish-challenge.py --no-replay --market
</pre></div>
</div>
<p>Now the output for the same period as above:</p>
<div class="highlight-python"><div class="highlight"><pre>...
0955,0478,0478,2006-11-22T00:00:00,27.51,28.56,27.29,28.49,16027900.00,0.00
High 28.56 &gt; Highest 28.56
LAST 19 highs: array(&#39;d&#39;, [25.33, 25.6, 26.4, 26.7, 26.62, 26.6, 26.7, 26.7, 27.15, 27.25, 27.65, 27.5, 27.62, 27.5, 27.5, 27.33, 27.05, 27.04, 27.34])
-- BUY on date: 2006-11-22
-- BUY Completed on: 2006-11-22
-- BUY Price: 27.51
0956,0478,0478,2006-11-22T23:59:59.999989,27.51,28.56,27.29,28.49,32055800.00,0.00
...
</pre></div>
</div>
<p>And the problem can be easily identified</p>
<blockquote>
<div><ul>
<li><p class="first">Instead of the <em>closing</em> price the order is executing with the <em>opening</em>
price, because the <em>Market</em> order takes the 1st price available in the 2nd
bar, namely <code class="docutils literal"><span class="pre">27.51</span></code>, which is unfortunately the <em>opening</em> price of the
day and no longer <em>available</em>.</p>
<p>This is due to the fact that the filter is not really <em>replaying</em> but
rather breaking up the bar in two parts and doing a soft <em>replaying</em></p>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="the-right-mod-solution">
<h2>The right &#8220;mod&#8221; solution<a class="headerlink" href="#the-right-mod-solution" title="Permalink to this headline">¶</a></h2>
<p>Getting also the <code class="docutils literal"><span class="pre">Market</span></code> order to pick the <em>closing</em> price.</p>
<p>This comprises:</p>
<blockquote>
<div><ul>
<li><p class="first">A filter which breaks the bar in two parts</p>
</li>
<li><p class="first">And is compatible with the standard <em>replay</em> functionality available in <em>backtrader</em></p>
<p>In this case the 2nd bar would be made up of just the <code class="docutils literal"><span class="pre">close</span></code> price and
even if the display shows a complete bar, the internal machinery only
matches orders against the <em>tick</em></p>
</li>
</ul>
</div></blockquote>
<p>Chaining filters in <em>backtrader</em> was already possible but this use case had not
been taken into account:</p>
<blockquote>
<div><ul>
<li><p class="first">Made 2 data &#8220;heartbeats&#8221; out of a single data &#8220;heartbeat&#8221;</p>
<p>Before this challenge it was about getting bars <em>merged</em> into larger bars.</p>
</li>
</ul>
</div></blockquote>
<p>A small extension into the core mechanism loading bars allows for a filter to
add the 2nd part of the bar to an internal stash for re-processing before a new
data <em>heartbeat</em> is taken into account. And because it is an <em>extension</em> and
not a <em>modification</em> it has no impact.</p>
<p>The challenge has also given the chance to:</p>
<blockquote>
<div><ul>
<li><p class="first">Look again into the early-age code written at the very beginning of
<em>backtrader</em> for <code class="docutils literal"><span class="pre">Close</span></code> orders.</p>
<p>And here a couple of lines and <code class="docutils literal"><span class="pre">if</span></code> conditions have been reworked to make
matching <code class="docutils literal"><span class="pre">Close</span></code> orders more logical and if possible to deliver them
instantly to the system (before the delivery of matching would mostly be
done with a 1-bar delay, even if matched to the right bar)</p>
</li>
</ul>
</div></blockquote>
<p>One good thing after these changes:</p>
<blockquote>
<div><ul class="simple">
<li>The logic in the filter is a lot easier, because there is no subtle
<em>replay</em> attempt. Replay is done by the <em>replay</em> filter.</li>
</ul>
</div></blockquote>
<p>The anatomy of the filter for the 1st part of the broken bar:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Copy the incoming data bar</li>
<li>Make a copy as the <em>OHL</em> bar (no Close)</li>
<li>Change the time to be <em>date</em> + <em>sessionstart</em> time</li>
<li>Remove part of the volume (specified with parameter <em>closevol</em> to the
filter)</li>
<li>Nullify <code class="docutils literal"><span class="pre">OpenInterest</span></code> (available at the end of the day)</li>
<li>Remove the <code class="docutils literal"><span class="pre">close</span></code> price and replace it with the average of <em>OHL</em></li>
<li>Add the bar to the internal <em>stack</em> for immediate processing by the next
filter or strategy (the <em>replay</em> filter will take over)</li>
</ol>
</div></blockquote>
<p>The anatomy for the 2nd part of the broken bar:</p>
<blockquote>
<div><ol class="arabic simple">
<li>Copy the incoming data bar</li>
<li>Replace OHL prices with the <code class="docutils literal"><span class="pre">Close</span></code> price</li>
<li>Change the time to be <em>date</em> + <em>sessionend</em> time</li>
<li>Remove the other part of the volume (specified with parameter <em>closevol</em>
to the filter)</li>
<li>Set <code class="docutils literal"><span class="pre">OpenInterest</span></code></li>
<li>Add the bar to the internal <em>stash</em> for delayed processing as the next
data heartbeat, rather than fetching prices from the data</li>
</ol>
</div></blockquote>
<p>The code:</p>
<div class="highlight-python"><div class="highlight"><pre>        <span class="c1"># Make a copy of current data for ohlbar</span>
        <span class="n">ohlbar</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">())]</span>
        <span class="n">closebar</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[:]</span>  <span class="c1"># Make a copy for the close</span>

        <span class="c1"># replace close price with o-h-l average</span>
        <span class="n">ohlprice</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">]</span> <span class="o">+</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">]</span> <span class="o">+</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]</span> <span class="o">=</span> <span class="n">ohlprice</span> <span class="o">/</span> <span class="mf">3.0</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span>  <span class="c1"># adjust volume</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">vohl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vol</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">closevol</span><span class="p">))</span>

        <span class="n">oi</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span>  <span class="c1"># adjust open interst</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Adjust times</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionstart</span><span class="p">)</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Adjust closebar to generate a single tick -&gt; close price</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span> <span class="o">=</span> <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">-</span> <span class="n">vohl</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="n">oi</span>

        <span class="c1"># Adjust times</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionend</span><span class="p">)</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Update stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># remove the copied bar from stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">ohlbar</span><span class="p">)</span>  <span class="c1"># add ohlbar to stack</span>
        <span class="c1"># Add 2nd part to stash to delay processing to next round</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">closebar</span><span class="p">,</span> <span class="n">stash</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># the length of the stream was not changed</span>

</pre></div>
</div>
<p>Executing without disabling <em>replay</em> and <code class="docutils literal"><span class="pre">Close</span></code> (let&#8217;s add plotting):</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./pinkfish-challenge.py --plot
</pre></div>
</div>
<p>The output for the same period:</p>
<div class="highlight-python"><div class="highlight"><pre>...
0955,0478,0478,2006-11-22T00:00:00,27.51,28.56,27.29,27.79,16027900.00,0.00
High 28.56 &gt; Highest 28.56
LAST 19 highs: array(&#39;d&#39;, [25.33, 25.6, 26.4, 26.7, 26.62, 26.6, 26.7, 26.7, 27.15, 27.25, 27.65, 27.5, 27.62, 27.5, 27.5, 27.33, 27.05, 27.04, 27.34])
-- BUY on date: 2006-11-22
-- BUY Completed on: 2006-11-22
-- BUY Price: 28.49
0956,0478,0478,2006-11-22T23:59:59.999989,27.51,28.56,27.29,28.49,32055800.00,0.00
...
</pre></div>
</div>
<p>Everything is ok and the <em>closing</em> price of <code class="docutils literal"><span class="pre">28.49</span></code> has been taken.</p>
<p>And the chart.</p>
<a class=""
               data-lightbox="group-4562b943-3813-4e0b-a4c6-c72e1c306c96"
               href="../../../_images/pinkfish-challenge1.png"
               title=""
               data-title=""
               ><img src="../../../_images/pinkfish-challenge1.png"
                     class=""
                     width="100%"
                     height="auto"
                     alt=""/>
                </a><p>And last but not least to check the modifications have made sense:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./pinkfish-challenge.py --market
</pre></div>
</div>
<p>The output for the same period:</p>
<div class="highlight-python"><div class="highlight"><pre>...
0955,0478,0478,2006-11-22T00:00:00,27.51,28.56,27.29,27.79,16027900.00,0.00
High 28.56 &gt; Highest 28.56
LAST 19 highs: array(&#39;d&#39;, [25.33, 25.6, 26.4, 26.7, 26.62, 26.6, 26.7, 26.7, 27.15, 27.25, 27.65, 27.5, 27.62, 27.5, 27.5, 27.33, 27.05, 27.04, 27.34])
-- BUY on date: 2006-11-22
-- BUY Completed on: 2006-11-22
-- BUY Price: 28.49
0956,0478,0478,2006-11-22T23:59:59.999989,27.51,28.56,27.29,28.49,32055800.00,0.00
..
</pre></div>
</div>
<p>And now the <code class="docutils literal"><span class="pre">Market</span></code> orders are picking the same price of <code class="docutils literal"><span class="pre">28.49</span></code> as the
<code class="docutils literal"><span class="pre">Close</span></code> orders, which in this particular use case was the expectation,
because <em>replaying</em> is happening and the 2nd part of the broken daily bar has a
single <em>tick</em>: <code class="docutils literal"><span class="pre">28.49</span></code> which is the <em>closing</em> price</p>
</div>
<div class="section" id="usage-of-the-sample">
<h2>Usage of the sample<a class="headerlink" href="#usage-of-the-sample" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre>$ ./pinkfish-challenge.py --help
usage: pinkfish-challenge.py [-h] [--data DATA] [--fromdate FROMDATE]
                             [--todate TODATE] [--cash CASH]
                             [--sellafter SELLAFTER] [--highperiod HIGHPERIOD]
                             [--no-replay] [--market] [--oldbuysell]
                             [--plot [kwargs]]

Sample for pinkfish challenge

optional arguments:
  -h, --help            show this help message and exit
  --data DATA           Data to be read in (default:
                        ../../datas/yhoo-1996-2015.txt)
  --fromdate FROMDATE   Starting date in YYYY-MM-DD format (default:
                        2005-01-01)
  --todate TODATE       Ending date in YYYY-MM-DD format (default: 2006-12-31)
  --cash CASH           Cash to start with (default: 50000)
  --sellafter SELLAFTER
                        Sell after so many bars in market (default: 2)
  --highperiod HIGHPERIOD
                        Period to look for the highest (default: 20)
  --no-replay           Use Replay + replay filter (default: False)
  --market              Use Market exec instead of Close (default: False)
  --oldbuysell          Old buysell plot behavior - ON THE PRICE (default:
                        False)
  --plot [kwargs], -p [kwargs]
                        Plot the read data applying any kwargs passed For
                        example (escape the quotes if needed): --plot
                        style=&quot;candle&quot; (to plot candles) (default: None)
</pre></div>
</div>
</div>
<div class="section" id="and-the-code-itself">
<h2>And the code itself<a class="headerlink" href="#and-the-code-itself" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">backtrader.indicators</span> <span class="kn">as</span> <span class="nn">btind</span>


<span class="k">class</span> <span class="nc">DayStepsCloseFilter</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">MetaParams</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Replays a bar in 2 steps:</span>

<span class="sd">      - In the 1st step the &quot;Open-High-Low&quot; could be evaluated to decide if to</span>
<span class="sd">        act on the close (the close is still there ... should not be evaluated)</span>

<span class="sd">      - If a &quot;Close&quot; order has been executed</span>

<span class="sd">        In this 1st fragment the &quot;Close&quot; is replaced through the &quot;open&quot; althoug</span>
<span class="sd">        other alternatives would be possible like high - low average, or an</span>
<span class="sd">        algorithm based on where the &quot;close&quot; ac</span>

<span class="sd">      and</span>

<span class="sd">      - Open-High-Low-Close</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;cvol&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="c1"># 0 -&gt; 1 amount of volume to keep for close</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Make a copy of the new bar and remove it from stream</span>
        <span class="n">closebar</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">())]</span>
        <span class="n">datadt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>  <span class="c1"># keep the date</span>

        <span class="n">ohlbar</span> <span class="o">=</span> <span class="n">closebar</span><span class="p">[:]</span>  <span class="c1"># Make an open-high-low bar</span>

        <span class="c1"># Adjust volume</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">cvol</span><span class="p">))</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionstart</span><span class="p">)</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionend</span><span class="p">)</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Update stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">()</span>  <span class="c1"># remove the copied bar from stream</span>
        <span class="c1"># Overwrite the new data bar with our pending data - except start point</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">_updatebar</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span> <span class="o">=</span> <span class="n">closebar</span>  <span class="c1"># update the pending bar to the new bar</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">ohlbar</span><span class="p">)</span>  <span class="c1"># Add the openbar to the stack for processing</span>

        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># the length of the stream was not changed</span>

    <span class="k">def</span> <span class="nf">last</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Called when the data is no longer producing bars</span>
<span class="sd">        Can be called multiple times. It has the chance to (for example)</span>
<span class="sd">        produce extra bars&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">()</span>  <span class="c1"># remove delivered open bar</span>
            <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span><span class="p">)</span>  <span class="c1"># add remaining</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pendingbar</span> <span class="o">=</span> <span class="bp">None</span>  <span class="c1"># No further action</span>
            <span class="k">return</span> <span class="bp">True</span>  <span class="c1"># something delivered</span>

        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># nothing delivered here</span>


<span class="k">class</span> <span class="nc">DayStepsReplayFilter</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">MetaParams</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Replays a bar in 2 steps:</span>

<span class="sd">      - In the 1st step the &quot;Open-High-Low&quot; could be evaluated to decide if to</span>
<span class="sd">        act on the close (the close is still there ... should not be evaluated)</span>

<span class="sd">      - If a &quot;Close&quot; order has been executed</span>

<span class="sd">        In this 1st fragment the &quot;Close&quot; is replaced through the &quot;open&quot; althoug</span>
<span class="sd">        other alternatives would be possible like high - low average, or an</span>
<span class="sd">        algorithm based on where the &quot;close&quot; ac</span>

<span class="sd">      and</span>

<span class="sd">      - Open-High-Low-Close</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;closevol&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>  <span class="c1"># 0 -&gt; 1 amount of volume to keep for close</span>
    <span class="p">)</span>

    <span class="c1"># replaying = True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lastdt</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># Make a copy of the new bar and remove it from stream</span>
        <span class="n">datadt</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>  <span class="c1"># keep the date</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lastdt</span> <span class="o">==</span> <span class="n">datadt</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># skip bars that come again in the filter</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lastdt</span> <span class="o">=</span> <span class="n">datadt</span>  <span class="c1"># keep ref to last seen bar</span>

        <span class="c1"># Make a copy of current data for ohlbar</span>
        <span class="n">ohlbar</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">())]</span>
        <span class="n">closebar</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[:]</span>  <span class="c1"># Make a copy for the close</span>

        <span class="c1"># replace close price with o-h-l average</span>
        <span class="n">ohlprice</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">]</span> <span class="o">+</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">]</span> <span class="o">+</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]</span> <span class="o">=</span> <span class="n">ohlprice</span> <span class="o">/</span> <span class="mf">3.0</span>

        <span class="n">vol</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span>  <span class="c1"># adjust volume</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">vohl</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">vol</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">closevol</span><span class="p">))</span>

        <span class="n">oi</span> <span class="o">=</span> <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span>  <span class="c1"># adjust open interst</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Adjust times</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionstart</span><span class="p">)</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Adjust closebar to generate a single tick -&gt; close price</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span> <span class="o">=</span> <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">]</span> <span class="o">=</span> <span class="n">cprice</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="n">vol</span> <span class="o">-</span> <span class="n">vohl</span>
        <span class="n">ohlbar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="n">oi</span>

        <span class="c1"># Adjust times</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">datadt</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sessionend</span><span class="p">)</span>
        <span class="n">closebar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># Update stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">(</span><span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>  <span class="c1"># remove the copied bar from stream</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">ohlbar</span><span class="p">)</span>  <span class="c1"># add ohlbar to stack</span>
        <span class="c1"># Add 2nd part to stash to delay processing to next round</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">closebar</span><span class="p">,</span> <span class="n">stash</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">False</span>  <span class="c1"># the length of the stream was not changed</span>


<span class="k">class</span> <span class="nc">St</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">):</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;highperiod&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;sellafter&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;market&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callcounter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">txtfields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Calls&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Len Strat&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Len Data&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Datetime&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Open&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;High&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Low&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Close&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Volume&#39;</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;OpenInterest&#39;</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txtfields</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lcontrol</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># control if 1st or 2nd call</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inmarket</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Get the highest but delayed 1 ... to avoid &quot;today&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">highest</span> <span class="o">=</span> <span class="n">btind</span><span class="o">.</span><span class="n">Highest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">high</span><span class="p">,</span>
                                     <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">highperiod</span><span class="p">,</span>
                                     <span class="n">subplot</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">notify_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">order</span><span class="o">.</span><span class="n">isbuy</span><span class="p">()</span> <span class="ow">and</span> <span class="n">order</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">order</span><span class="o">.</span><span class="n">Completed</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-- BUY Completed on:&#39;</span><span class="p">,</span>
                  <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-- BUY Price:&#39;</span><span class="p">,</span> <span class="n">order</span><span class="o">.</span><span class="n">executed</span><span class="o">.</span><span class="n">price</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callcounter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">txtfields</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">callcounter</span><span class="p">)</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%04d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="p">))</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="o">.</span><span class="n">open</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="o">.</span><span class="n">low</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="o">.</span><span class="n">close</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="o">.</span><span class="n">volume</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">txtfields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">data0</span><span class="o">.</span><span class="n">openinterest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">txtfields</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">position</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">lcontrol</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">high</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">highest</span><span class="p">:</span>  <span class="c1"># today is highest!!!</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;High </span><span class="si">%.2f</span><span class="s1"> &gt; Highest </span><span class="si">%.2f</span><span class="s1">&#39;</span> <span class="o">%</span>
                          <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">high</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">highest</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;LAST 19 highs:&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">high</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">19</span><span class="p">,</span> <span class="n">ago</span><span class="o">=-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="k">print</span><span class="p">(</span><span class="s1">&#39;-- BUY on date:&#39;</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">))</span>
                    <span class="n">ex</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Order</span><span class="o">.</span><span class="n">Market</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">market</span> <span class="k">else</span> <span class="n">bt</span><span class="o">.</span><span class="n">Order</span><span class="o">.</span><span class="n">Close</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">buy</span><span class="p">(</span><span class="n">exectype</span><span class="o">=</span><span class="n">ex</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">inmarket</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># reset period in market</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># in the market</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">inmarket</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">sellafter</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sell</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lcontrol</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">runstrat</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">set_cash</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">cash</span><span class="p">)</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">broker</span><span class="o">.</span><span class="n">set_eosbar</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">dkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">fromdate</span><span class="p">:</span>
        <span class="n">fromdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fromdate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dkwargs</span><span class="p">[</span><span class="s1">&#39;fromdate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fromdate</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">todate</span><span class="p">:</span>
        <span class="n">todate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">todate</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">dkwargs</span><span class="p">[</span><span class="s1">&#39;todate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">todate</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">no_replay</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">BacktraderCSVData</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Days</span><span class="p">,</span>
                                          <span class="n">compression</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">dkwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="n">DayStepsCloseFilter</span><span class="p">)</span>
        <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">feeds</span><span class="o">.</span><span class="n">BacktraderCSVData</span><span class="p">(</span><span class="n">dataname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                                          <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Minutes</span><span class="p">,</span>
                                          <span class="n">compression</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">dkwargs</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="n">DayStepsReplayFilter</span><span class="p">)</span>
        <span class="n">cerebro</span><span class="o">.</span><span class="n">replaydata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Days</span><span class="p">,</span> <span class="n">compression</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">St</span><span class="p">,</span>
                        <span class="n">sellafter</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">sellafter</span><span class="p">,</span>
                        <span class="n">highperiod</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">highperiod</span><span class="p">,</span>
                        <span class="n">market</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">market</span><span class="p">)</span>

    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">runonce</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">preload</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">oldbuysell</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">oldbuysell</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">pkwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">True</span><span class="p">:</span>  <span class="c1"># evals to True but is not True</span>
            <span class="n">npkwargs</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="s1">&#39;dict(&#39;</span> <span class="o">+</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">)</span>  <span class="c1"># args were passed</span>
            <span class="n">pkwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">npkwargs</span><span class="p">)</span>

        <span class="n">cerebro</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">**</span><span class="n">pkwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">(</span><span class="n">pargs</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentDefaultsHelpFormatter</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Sample for pinkfish challenge&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--data&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;../../datas/yhoo-1996-2015.txt&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Data to be read in&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--fromdate&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;2005-01-01&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Starting date in YYYY-MM-DD format&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--todate&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s1">&#39;2006-12-31&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s1">&#39;Ending date in YYYY-MM-DD format&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--cash&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Cash to start with&#39;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--sellafter&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Sell after so many bars in market&#39;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--highperiod&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store&#39;</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Period to look for the highest&#39;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--no-replay&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Use Replay + replay filter&#39;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--market&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Use Market exec instead of Close&#39;</span><span class="p">))</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--oldbuysell&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Old buysell plot behavior - ON THE PRICE&#39;</span><span class="p">))</span>

    <span class="c1"># Plot options</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;--plot&#39;</span><span class="p">,</span> <span class="s1">&#39;-p&#39;</span><span class="p">,</span> <span class="n">nargs</span><span class="o">=</span><span class="s1">&#39;?&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                        <span class="n">metavar</span><span class="o">=</span><span class="s1">&#39;kwargs&#39;</span><span class="p">,</span> <span class="n">const</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Plot the read data applying any kwargs passed</span><span class="se">\n</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;For example (escape the quotes if needed):</span><span class="se">\n</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                              <span class="s1">&#39;  --plot style=&quot;candle&quot; (to plot candles)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">pargs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">(</span><span class="n">pargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">runstrat</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="../../2016-07-26-talib-integration/talib-integration/">
    <i class="fa fa-arrow-circle-left"></i>
    TA-Lib
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
  
  <a href="../../2016-07-30-macd-settings/macd-settings/">
    MACD Settings
    <i class="fa fa-arrow-circle-right"></i>
  </a>
  </span>
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'backtrader'; // required: replace example with your forum shortname
        var disqus_identifier = '/posts/2016-07-29-pinkfish-challenge/pinkfish-challenge/';
        var disqus_title = 'Pinkfish Challenge';
        var disqus_url = 'http://www.backtrader.com/posts/2016-07-29-pinkfish-challenge/pinkfish-challenge';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../">backtrader</a></h1>





<p>
<iframe src="https://ghbtns.com/github-btn.html?user=mementum&repo=backtrader&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>




    

<p>
<a href="https://travis-ci.org/mementum/backtrader">
    <img
        alt="https://secure.travis-ci.org/mementum/backtrader.png?branch=master"
        src="https://secure.travis-ci.org/mementum/backtrader.png?branch=master"
    />
</a>
</p>



  
  
  <h2>
  
  <i class="fa fa-calendar"></i>
    Jul 29, 2016
  
  </h2>

  <ul>
    

  
  <li><i class="fa-fw fa fa-user"></i>
    
      
      <a href="../../../blog/author/mementum/">mementum</a>
      
    </li>
  

  

  

  

  
  
  <li>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'backtrader'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    <i class="fa-fw fa fa-comments"></i>
    <a href="#disqus_thread" data-disqus-identifier="/posts/2016-07-29-pinkfish-challenge/pinkfish-challenge/"> </a>
  </li>
  
  </ul>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/">About backtrader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/#documentation">Documentation</a></li>
</ul>


  <h3><a href="../../../blog/">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../../2016-09-02-target-orders/target-orders/">Sep 02 - Target Orders</a></li>
    
      <li><a href="../../2016-08-31-rolling-over-futures/rolling-futures-over/">Aug 31 - Rolling over Futures</a></li>
    
      <li><a href="../../2016-08-22-credit-interest/credit-interest/">Aug 22 - Credit Interest</a></li>
    
      <li><a href="../../2016-08-18-dickson-moving-average/dickson-moving-average/">Aug 17 - Dickson Moving Average</a></li>
    
      <li><a href="../../2016-08-15-stock-screening/stock-screening/">Aug 15 - Stock Screening</a></li>
    
  </ul>

  <h3><a href="../../../blog/archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../../../blog/2016/">2016 (24)</a></li>
    
  
    
    <li><a href="../../../blog/2015/">2015 (27)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, mementum.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
      |
      <a href="../../../_sources/posts/2016-07-29-pinkfish-challenge/pinkfish-challenge.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/mementum/backtrader" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-2435868-6']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>