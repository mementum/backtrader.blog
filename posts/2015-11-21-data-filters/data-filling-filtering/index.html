<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Data Filters &mdash; backtrader  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/sphinxcontrib-images\LightBox2\lightbox2\css\lightbox.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../../../_static/sphinxcontrib-images\LightBox2\lightbox2\js\lightbox.min.js"></script>
    <script type="text/javascript" src="../../../_static/sphinxcontrib-images\LightBox2\lightbox2-customize\jquery-noconflict.js"></script>
    <link rel="author" title="About these documents" href="../../../about/" />
    <link rel="top" title="backtrader  documentation" href="../../../" />
  
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  
  
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.post-list-style-disc {list-style-type: disc;}
    ul.post-list-style-none {list-style-type: none;}
    ul.post-list-style-circle {list-style-type: circle;}
  </style>

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="data-filters">
<h1>Data Filters<a class="headerlink" href="#data-filters" title="Permalink to this headline">¶</a></h1>
<p>Some time ago <a class="reference external" href="https://github.com/mementum/backtrader/issues/23">Ticket #23</a>
got me thinking about a potential improvement for the discussion which was held
in the context of that ticket.</p>
<p>Within the ticket I added a <code class="docutils literal"><span class="pre">DataFilter</span></code> class, but this was overly
complicated. Actually reminiscent of the complexity which was built in
<code class="docutils literal"><span class="pre">DataResampler</span></code> and <code class="docutils literal"><span class="pre">DataReplayer</span></code>, the classes used to implement the
functionalities of the same names.</p>
<p>As such and since a couple of versions, <code class="docutils literal"><span class="pre">backtrader</span></code> supports adding a
<code class="docutils literal"><span class="pre">filter</span></code> (call it <code class="docutils literal"><span class="pre">processor</span></code> if you wish) to data feeds. Resampling and
Replaying were internally reimplemented using the functionality and everything
seems less complicated (although it still is)</p>
<div class="section" id="filters-at-work">
<h2>Filters at work<a class="headerlink" href="#filters-at-work" title="Permalink to this headline">¶</a></h2>
<p>Given an existing data feed/source you use the <code class="docutils literal"><span class="pre">addfilter</span></code> method of the data
feed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">MyDataFeed</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">myname</span><span class="p">)</span>

<span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
<p>Obviously the <code class="docutils literal"><span class="pre">filter</span></code> must conform to a given interface, being this:</p>
<blockquote>
<div><ul>
<li><p class="first">A callable which accepts this signature:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="nb">callable</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ul>
<p>or</p>
<ul>
<li><p class="first">A class which can be instantiated and called</p>
<ul>
<li><p class="first">During instantiation the __init__ method must support the signature:</p>
<div class="highlight-python"><div class="highlight"><pre>def __init__(self, data, *args, **kwargs)
</pre></div>
</div>
</li>
<li><p class="first">The __call__ and last methods this one:</p>
<div class="highlight-python"><div class="highlight"><pre>def __call__(self, data)

def last(self, data)
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div></blockquote>
<p>The callable/instance will be called for each data the data source is producing.</p>
</div>
<div class="section" id="a-better-solution-for-ticket-23">
<h2>A better solution for Ticket #23<a class="headerlink" href="#a-better-solution-for-ticket-23" title="Permalink to this headline">¶</a></h2>
<p>That ticket wanted:</p>
<blockquote>
<div><ul class="simple">
<li>A RelativeVolumeIndicator on an intraday basis</li>
<li>Intraday data may be missing</li>
<li>Pre/Post Session data could arrive</li>
</ul>
</div></blockquote>
<p>Implementing a couple of filters alleviates the situation for a backtesting
environment.</p>
<div class="section" id="filtering-out-pre-post-market-data">
<h3>Filtering out Pre/Post Market Data<a class="headerlink" href="#filtering-out-pre-post-market-data" title="Permalink to this headline">¶</a></h3>
<p>The following filter (already available in <code class="docutils literal"><span class="pre">backtrader</span></code>) comes to the rescue:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionFilter</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">metabase</span><span class="o">.</span><span class="n">MetaParams</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class can be applied to a data source as a filter and will filter out</span>
<span class="sd">    intraday bars which fall outside of the regular session times (ie: pre/post</span>
<span class="sd">    market data)</span>

<span class="sd">    This is a &quot;non-simple&quot; filter and must manage the stack of the data (passed</span>
<span class="sd">    during init and __call__)</span>

<span class="sd">    It needs no &quot;last&quot; method because it has nothing to deliver</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Return Values:</span>

<span class="sd">          - False: data stream was not touched</span>
<span class="sd">          - True: data stream was manipulated (bar outside of session times and</span>
<span class="sd">          - removed)</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">sessionstart</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">tm</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">sessionend</span><span class="p">:</span>
            <span class="c"># Both ends of the comparison are in the session</span>
            <span class="k">return</span> <span class="bp">False</span>  <span class="c"># say the stream is untouched</span>

        <span class="c"># bar outside of the regular session times</span>
        <span class="n">data</span><span class="o">.</span><span class="n">backwards</span><span class="p">()</span>  <span class="c"># remove bar from data stack</span>
        <span class="k">return</span> <span class="bp">True</span>  <span class="c"># signal the data was manipulated</span>
</pre></div>
</div>
<p>The filter uses the in-the-data embedded session start/end times to filter
bars</p>
<blockquote>
<div><ul class="simple">
<li>If the datetime of the new data is within the session times <code class="docutils literal"><span class="pre">False</span></code> is
returned to indicate the data is untouched</li>
<li>If the datatime falls outside of the range, the data source is sent
<code class="docutils literal"><span class="pre">backwards</span></code> effectively erasing the last produced data. And <code class="docutils literal"><span class="pre">True</span></code> is
returned to indicate the data stream was manipulated.</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Calling <code class="docutils literal"><span class="pre">data.backwards()</span></code> is possibly/probably low level and the
filters should have an API which deals with the internals of the data
stream</p>
</div>
<p>The sample code at the end of the script can be run with and without filter. The
first run is 100% unfiltered and without specifying session times:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./data-filler.py --writer --wrcsv
</pre></div>
</div>
<p>Looking at the start and end of the 1st day:</p>
<div class="highlight-python"><div class="highlight"><pre>===============================================================================
Id,2006-01-02-volume-min-001,len,datetime,open,high,low,close,volume,openinterest,Strategy,len
1,2006-01-02-volume-min-001,1,2006-01-02 09:01:00,3602.0,3603.0,3597.0,3599.0,5699.0,0.0,Strategy,1
2,2006-01-02-volume-min-001,2,2006-01-02 09:02:00,3600.0,3601.0,3598.0,3599.0,894.0,0.0,Strategy,2
...
...
581,2006-01-02-volume-min-001,581,2006-01-02 19:59:00,3619.0,3619.0,3619.0,3619.0,1.0,0.0,Strategy,581
582,2006-01-02-volume-min-001,582,2006-01-02 20:00:00,3618.0,3618.0,3617.0,3618.0,242.0,0.0,Strategy,582
583,2006-01-02-volume-min-001,583,2006-01-02 20:01:00,3618.0,3618.0,3617.0,3617.0,15.0,0.0,Strategy,583
584,2006-01-02-volume-min-001,584,2006-01-02 20:04:00,3617.0,3617.0,3617.0,3617.0,107.0,0.0,Strategy,584
585,2006-01-02-volume-min-001,585,2006-01-03 09:01:00,3623.0,3625.0,3622.0,3624.0,4026.0,0.0,Strategy,585
...
</pre></div>
</div>
<p>The session run from 09:01:00 to 20:04:00 on the 2nd of January of 2006.</p>
<p>Now a run with a <code class="docutils literal"><span class="pre">SessionFilter</span></code> and telling the script to use 09:30 and 17:30
as the start/end times of the session:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ./data-filler.py --writer --wrcsv --tstart 09:30 --tend 17:30 --filter

===============================================================================
Id,2006-01-02-volume-min-001,len,datetime,open,high,low,close,volume,openinterest,Strategy,len
1,2006-01-02-volume-min-001,1,2006-01-02 09:30:00,3604.0,3605.0,3603.0,3604.0,546.0,0.0,Strategy,1
2,2006-01-02-volume-min-001,2,2006-01-02 09:31:00,3604.0,3606.0,3604.0,3606.0,438.0,0.0,Strategy,2
...
...
445,2006-01-02-volume-min-001,445,2006-01-02 17:29:00,3621.0,3621.0,3620.0,3620.0,866.0,0.0,Strategy,445
446,2006-01-02-volume-min-001,446,2006-01-02 17:30:00,3620.0,3621.0,3619.0,3621.0,1670.0,0.0,Strategy,446
447,2006-01-02-volume-min-001,447,2006-01-03 09:30:00,3637.0,3638.0,3635.0,3636.0,1458.0,0.0,Strategy,447
...
</pre></div>
</div>
<p>The data output starts now at 09:30 and ends at 17:30. Pre/Post-Market Data has
been filtered out.</p>
</div>
<div class="section" id="filling-in-missing-data">
<h3>Filling in Missing Data<a class="headerlink" href="#filling-in-missing-data" title="Permalink to this headline">¶</a></h3>
<p>A deeper examination of the output shows the following:</p>
<div class="highlight-python"><div class="highlight"><pre>...
61,2006-01-02-volume-min-001,61,2006-01-02 10:30:00,3613.0,3614.0,3613.0,3614.0,112.0,0.0,Strategy,61
62,2006-01-02-volume-min-001,62,2006-01-02 10:31:00,3614.0,3614.0,3614.0,3614.0,183.0,0.0,Strategy,62
63,2006-01-02-volume-min-001,63,2006-01-02 10:34:00,3614.0,3614.0,3614.0,3614.0,841.0,0.0,Strategy,63
64,2006-01-02-volume-min-001,64,2006-01-02 10:35:00,3614.0,3614.0,3614.0,3614.0,17.0,0.0,Strategy,64
...
</pre></div>
</div>
<p>Data for minutes 10:32 and 10:33 is missing. Being the 1st trading day of the
year there may have been no negotiation at all. Or the data feed may have failed
to capture that data.</p>
<p>For the purposes of Ticket #23 and to be able to compare the volume of a given
minute with the same minute of the previous day, we&#8217;ll be filling in the missing
data.</p>
<p>Already in <code class="docutils literal"><span class="pre">backtrader</span></code> there is a <code class="docutils literal"><span class="pre">SessionFiller</span></code> which as expected fills
in missing data. The code is long and bears more complexities than that of a
filter (see at the end for the full implementation), but let&#8217;s see the
class/params definition:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionFiller</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">metabase</span><span class="o">.</span><span class="n">MetaParams</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bar Filler for a Data Source inside the declared session start/end times.</span>

<span class="sd">    The fill bars are constructed using the declared Data Source ``timeframe``</span>
<span class="sd">    and ``compression`` (used to calculate the intervening missing times)</span>

<span class="sd">    Params:</span>

<span class="sd">      - fill_price (def: None):</span>

<span class="sd">        If None is passed, the closing price of the previous bar will be</span>
<span class="sd">        used. To end up with a bar which for example takes time but it is not</span>
<span class="sd">        displayed in a plot ... use float(&#39;Nan&#39;)</span>

<span class="sd">      - fill_vol (def: float(&#39;NaN&#39;)):</span>

<span class="sd">        Value to use to fill the missing volume</span>

<span class="sd">      - fill_oi (def: float(&#39;NaN&#39;)):</span>

<span class="sd">        Value to use to fill the missing Open Interest</span>

<span class="sd">      - skip_first_fill (def: True):</span>

<span class="sd">        Upon seeing the 1st valid bar do not fill from the sessionstart up to</span>
<span class="sd">        that bar</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;fill_price&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
              <span class="p">(</span><span class="s">&#39;fill_vol&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">)),</span>
              <span class="p">(</span><span class="s">&#39;fill_oi&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">)),</span>
              <span class="p">(</span><span class="s">&#39;skip_first_fill&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
</pre></div>
</div>
<p>The sample script can now filter and fill data:</p>
<div class="highlight-python"><div class="highlight"><pre>./data-filler.py --writer --wrcsv --tstart 09:30 --tend 17:30 --filter --filler

...
62,2006-01-02-volume-min-001,62,2006-01-02 10:31:00,3614.0,3614.0,3614.0,3614.0,183.0,0.0,Strategy,62
63,2006-01-02-volume-min-001,63,2006-01-02 10:32:00,3614.0,3614.0,3614.0,3614.0,0.0,,Strategy,63
64,2006-01-02-volume-min-001,64,2006-01-02 10:33:00,3614.0,3614.0,3614.0,3614.0,0.0,,Strategy,64
65,2006-01-02-volume-min-001,65,2006-01-02 10:34:00,3614.0,3614.0,3614.0,3614.0,841.0,0.0,Strategy,65
...
</pre></div>
</div>
<p>Minutes 10:32 and 10:33 are there. The script uses the last known &#8220;close&#8221; price
to fill the price values and sets the volume and openinterest fields to 0. The
script accepts a <code class="docutils literal"><span class="pre">--fvol</span></code> argument to set the volume to anything (including
&#8216;NaN&#8217;)</p>
</div>
<div class="section" id="completing-ticket-23">
<h3>Completing Ticket #23<a class="headerlink" href="#completing-ticket-23" title="Permalink to this headline">¶</a></h3>
<p>With the <code class="docutils literal"><span class="pre">SessionFilter</span></code> and <code class="docutils literal"><span class="pre">SessionFiller</span></code> the following has been
completed:</p>
<blockquote>
<div><ul class="simple">
<li>Pre/Post Market Data is not delivered</li>
<li>No Data (for the given timeframe) is missing</li>
</ul>
</div></blockquote>
<p>Now the &#8220;synchronization&#8221; discussed in Ticket 23 to implement a
<code class="docutils literal"><span class="pre">RelativeVolume</span></code> indicator is no longer needed, because all days have exactly
the same number of bars (in the example all minutes from 09:30 to 17:30 both
included)</p>
<p>Remembering that the default is to set the missing volume to <code class="docutils literal"><span class="pre">0</span></code> an easy
<code class="docutils literal"><span class="pre">RelativeVolume</span></code> indicator can be developed:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">RelativeVolume</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Indicator</span><span class="p">):</span>
    <span class="n">csv</span> <span class="o">=</span> <span class="bp">True</span>  <span class="c"># show up in csv output (default for indicators is False)</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;relvol&#39;</span><span class="p">,)</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s">&#39;period&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
        <span class="p">(</span><span class="s">&#39;volisnan&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">volisnan</span><span class="p">:</span>
            <span class="c"># if missing volume will be NaN, do a simple division</span>
            <span class="c"># the end result for missing volumes will also be NaN</span>
            <span class="n">relvol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">period</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">volume</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Else do a controlled Div with a built-in function</span>
            <span class="n">relvol</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">DivByZero</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">period</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span>
                <span class="n">zero</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="o">.</span><span class="n">relvol</span> <span class="o">=</span> <span class="n">relvol</span>
</pre></div>
</div>
<p>Which is smart enough to avoid a division by zero by using a built-in aid in
<code class="docutils literal"><span class="pre">backtrader</span></code>.</p>
<p>Putting all pieces together in the next invocation of the script:</p>
<div class="highlight-python"><div class="highlight"><pre>./data-filler.py --writer --wrcsv --tstart 09:30 --tend 17:30 --filter --filler --relvol

===============================================================================
Id,2006-01-02-volume-min-001,len,datetime,open,high,low,close,volume,openinterest,Strategy,len,RelativeVolume,len,relvol
1,2006-01-02-volume-min-001,1,2006-01-02 09:30:00,3604.0,3605.0,3603.0,3604.0,546.0,0.0,Strategy,1,RelativeVolume,1,
2,2006-01-02-volume-min-001,2,2006-01-02 09:31:00,3604.0,3606.0,3604.0,3606.0,438.0,0.0,Strategy,2,RelativeVolume,2,
...
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">RelativeVolume</span></code> indicator produces no output, as expected, during the 1st
bars. The period is calculated in the script as: (17:30 - 09:30 * 60) + 1. Let&#8217;s
directly look at how the relative volume looks for 10:32 and 10:33 in the second
day, given that the 1st day, the volume value was filled with <code class="docutils literal"><span class="pre">0</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>...
543,2006-01-02-volume-min-001,543,2006-01-03 10:31:00,3648.0,3648.0,3647.0,3648.0,56.0,0.0,Strategy,543,RelativeVolume,543,3.26785714286
544,2006-01-02-volume-min-001,544,2006-01-03 10:32:00,3647.0,3648.0,3647.0,3647.0,313.0,0.0,Strategy,544,RelativeVolume,544,0.0
545,2006-01-02-volume-min-001,545,2006-01-03 10:33:00,3647.0,3647.0,3647.0,3647.0,135.0,0.0,Strategy,545,RelativeVolume,545,0.0
546,2006-01-02-volume-min-001,546,2006-01-03 10:34:00,3648.0,3648.0,3647.0,3648.0,171.0,0.0,Strategy,546,RelativeVolume,546,4.91812865497
...
</pre></div>
</div>
<p>It is set to <code class="docutils literal"><span class="pre">0</span></code> as expected for both.</p>
</div>
<div class="section" id="conclusion">
<h3>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal"><span class="pre">filter</span></code> mechanism in data sources opens the possibility to fully
manipulate the data stream. Use with caution.</p>
</div>
<div class="section" id="script-code-and-usage">
<h3>Script Code and Usage<a class="headerlink" href="#script-code-and-usage" title="Permalink to this headline">¶</a></h3>
<p>Available as sample in the sources of <code class="docutils literal"><span class="pre">backtrader</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre>usage: data-filler.py [-h] [--data DATA] [--filter] [--filler] [--fvol FVOL]
                      [--tstart TSTART] [--tend TEND] [--relvol]
                      [--fromdate FROMDATE] [--todate TODATE] [--writer]
                      [--wrcsv] [--plot] [--numfigs NUMFIGS]

DataFilter/DataFiller Sample

optional arguments:
  -h, --help            show this help message and exit
  --data DATA, -d DATA  data to add to the system
  --filter, -ft         Filter using session start/end times
  --filler, -fl         Fill missing bars inside start/end times
  --fvol FVOL           Use as fill volume for missing bar (def: 0.0)
  --tstart TSTART, -ts TSTART
                        Start time for the Session Filter (HH:MM)
  --tend TEND, -te TEND
                        End time for the Session Filter (HH:MM)
  --relvol, -rv         Add relative volume indicator
  --fromdate FROMDATE, -f FROMDATE
                        Starting date in YYYY-MM-DD format
  --todate TODATE, -t TODATE
                        Starting date in YYYY-MM-DD format
  --writer, -w          Add a writer to cerebro
  --wrcsv, -wc          Enable CSV Output in the writer
  --plot, -p            Plot the read data
  --numfigs NUMFIGS, -n NUMFIGS
                        Plot using numfigs figures
</pre></div>
</div>
<p>The code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="p">(</span><span class="n">absolute_import</span><span class="p">,</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span><span class="p">,</span>
                        <span class="n">unicode_literals</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="c"># The above could be sent to an independent module</span>
<span class="kn">import</span> <span class="nn">backtrader</span> <span class="kn">as</span> <span class="nn">bt</span>
<span class="kn">import</span> <span class="nn">backtrader.feeds</span> <span class="kn">as</span> <span class="nn">btfeeds</span>
<span class="kn">import</span> <span class="nn">backtrader.utils.flushfile</span>
<span class="kn">import</span> <span class="nn">backtrader.filters</span> <span class="kn">as</span> <span class="nn">btfilters</span>

<span class="kn">from</span> <span class="nn">relativevolume</span> <span class="kn">import</span> <span class="n">RelativeVolume</span>


<span class="k">def</span> <span class="nf">runstrategy</span><span class="p">():</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parse_args</span><span class="p">()</span>

    <span class="c"># Create a cerebro</span>
    <span class="n">cerebro</span> <span class="o">=</span> <span class="n">bt</span><span class="o">.</span><span class="n">Cerebro</span><span class="p">()</span>

    <span class="c"># Get the dates from the args</span>
    <span class="n">fromdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fromdate</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>
    <span class="n">todate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">todate</span><span class="p">,</span> <span class="s">&#39;%Y-%m-</span><span class="si">%d</span><span class="s">&#39;</span><span class="p">)</span>

    <span class="c"># Get the session times to pass them to the indicator</span>
    <span class="c"># datetime.time has no strptime ...</span>
    <span class="n">dtstart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tstart</span><span class="p">,</span> <span class="s">&#39;%H:%M&#39;</span><span class="p">)</span>
    <span class="n">dtend</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">tend</span><span class="p">,</span> <span class="s">&#39;%H:%M&#39;</span><span class="p">)</span>

    <span class="c"># Create the 1st data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">btfeeds</span><span class="o">.</span><span class="n">BacktraderCSVData</span><span class="p">(</span>
        <span class="n">dataname</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
        <span class="n">fromdate</span><span class="o">=</span><span class="n">fromdate</span><span class="p">,</span>
        <span class="n">todate</span><span class="o">=</span><span class="n">todate</span><span class="p">,</span>
        <span class="n">timeframe</span><span class="o">=</span><span class="n">bt</span><span class="o">.</span><span class="n">TimeFrame</span><span class="o">.</span><span class="n">Minutes</span><span class="p">,</span>
        <span class="n">compression</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">sessionstart</span><span class="o">=</span><span class="n">dtstart</span><span class="p">,</span>  <span class="c"># internally just the &quot;time&quot; part will be used</span>
        <span class="n">sessionend</span><span class="o">=</span><span class="n">dtend</span><span class="p">,</span>  <span class="c"># internally just the &quot;time&quot; part will be used</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">filter</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="n">btfilters</span><span class="o">.</span><span class="n">SessionFilter</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">filler</span><span class="p">:</span>
        <span class="n">data</span><span class="o">.</span><span class="n">addfilter</span><span class="p">(</span><span class="n">btfilters</span><span class="o">.</span><span class="n">SessionFiller</span><span class="p">,</span> <span class="n">fill_vol</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">fvol</span><span class="p">)</span>

    <span class="c"># Add the data to cerebro</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">adddata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">relvol</span><span class="p">:</span>
        <span class="c"># Calculate backward period - tend tstart are in same day</span>
        <span class="c"># + 1 to include last moment of the interval dstart &lt;-&gt; dtend</span>
        <span class="n">td</span> <span class="o">=</span> <span class="p">((</span><span class="n">dtend</span> <span class="o">-</span> <span class="n">dtstart</span><span class="p">)</span><span class="o">.</span><span class="n">seconds</span> <span class="o">//</span> <span class="mi">60</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">cerebro</span><span class="o">.</span><span class="n">addindicator</span><span class="p">(</span><span class="n">RelativeVolume</span><span class="p">,</span>
                             <span class="n">period</span><span class="o">=</span><span class="n">td</span><span class="p">,</span>
                             <span class="n">volisnan</span><span class="o">=</span><span class="n">math</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">fvol</span><span class="p">))</span>

    <span class="c"># Add an empty strategy</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">addstrategy</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">Strategy</span><span class="p">)</span>

    <span class="c"># Add a writer with CSV</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">writer</span><span class="p">:</span>
        <span class="n">cerebro</span><span class="o">.</span><span class="n">addwriter</span><span class="p">(</span><span class="n">bt</span><span class="o">.</span><span class="n">WriterFile</span><span class="p">,</span> <span class="n">csv</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">wrcsv</span><span class="p">)</span>

    <span class="c"># And run it - no trading - disable stdstats</span>
    <span class="n">cerebro</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">stdstats</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="c"># Plot if requested</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>
        <span class="n">cerebro</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">numfigs</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">numfigs</span><span class="p">,</span> <span class="n">volume</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parse_args</span><span class="p">():</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s">&#39;DataFilter/DataFiller Sample&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--data&#39;</span><span class="p">,</span> <span class="s">&#39;-d&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s">&#39;../../datas/2006-01-02-volume-min-001.txt&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;data to add to the system&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--filter&#39;</span><span class="p">,</span> <span class="s">&#39;-ft&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Filter using session start/end times&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--filler&#39;</span><span class="p">,</span> <span class="s">&#39;-fl&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Fill missing bars inside start/end times&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--fvol&#39;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                        <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Use as fill volume for missing bar (def: 0.0)&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--tstart&#39;</span><span class="p">,</span> <span class="s">&#39;-ts&#39;</span><span class="p">,</span>
                        <span class="c"># default=&#39;09:14:59&#39;,</span>
                        <span class="c"># help=&#39;Start time for the Session Filter (%H:%M:%S)&#39;)</span>
                        <span class="n">default</span><span class="o">=</span><span class="s">&#39;09:15&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Start time for the Session Filter (HH:MM)&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--tend&#39;</span><span class="p">,</span> <span class="s">&#39;-te&#39;</span><span class="p">,</span>
                        <span class="c"># default=&#39;17:15:59&#39;,</span>
                        <span class="c"># help=&#39;End time for the Session Filter (%H:%M:%S)&#39;)</span>
                        <span class="n">default</span><span class="o">=</span><span class="s">&#39;17:15&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;End time for the Session Filter (HH:MM)&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--relvol&#39;</span><span class="p">,</span> <span class="s">&#39;-rv&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Add relative volume indicator&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--fromdate&#39;</span><span class="p">,</span> <span class="s">&#39;-f&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s">&#39;2006-01-01&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Starting date in YYYY-MM-DD format&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--todate&#39;</span><span class="p">,</span> <span class="s">&#39;-t&#39;</span><span class="p">,</span>
                        <span class="n">default</span><span class="o">=</span><span class="s">&#39;2006-12-31&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Starting date in YYYY-MM-DD format&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--writer&#39;</span><span class="p">,</span> <span class="s">&#39;-w&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Add a writer to cerebro&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--wrcsv&#39;</span><span class="p">,</span> <span class="s">&#39;-wc&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Enable CSV Output in the writer&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--plot&#39;</span><span class="p">,</span> <span class="s">&#39;-p&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s">&#39;store_true&#39;</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Plot the read data&#39;</span><span class="p">)</span>

    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s">&#39;--numfigs&#39;</span><span class="p">,</span> <span class="s">&#39;-n&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">help</span><span class="o">=</span><span class="s">&#39;Plot using numfigs figures&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">runstrategy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="sessionfiller">
<h3>SessionFiller<a class="headerlink" href="#sessionfiller" title="Permalink to this headline">¶</a></h3>
<p>From the <code class="docutils literal"><span class="pre">backtrader</span></code> sources:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">SessionFiller</span><span class="p">(</span><span class="n">with_metaclass</span><span class="p">(</span><span class="n">metabase</span><span class="o">.</span><span class="n">MetaParams</span><span class="p">,</span> <span class="nb">object</span><span class="p">)):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Bar Filler for a Data Source inside the declared session start/end times.</span>

<span class="sd">    The fill bars are constructed using the declared Data Source ``timeframe``</span>
<span class="sd">    and ``compression`` (used to calculate the intervening missing times)</span>

<span class="sd">    Params:</span>

<span class="sd">      - fill_price (def: None):</span>

<span class="sd">        If None is passed, the closing price of the previous bar will be</span>
<span class="sd">        used. To end up with a bar which for example takes time but it is not</span>
<span class="sd">        displayed in a plot ... use float(&#39;Nan&#39;)</span>

<span class="sd">      - fill_vol (def: float(&#39;NaN&#39;)):</span>

<span class="sd">        Value to use to fill the missing volume</span>

<span class="sd">      - fill_oi (def: float(&#39;NaN&#39;)):</span>

<span class="sd">        Value to use to fill the missing Open Interest</span>

<span class="sd">      - skip_first_fill (def: True):</span>

<span class="sd">        Upon seeing the 1st valid bar do not fill from the sessionstart up to</span>
<span class="sd">        that bar</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">((</span><span class="s">&#39;fill_price&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span>
              <span class="p">(</span><span class="s">&#39;fill_vol&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">)),</span>
              <span class="p">(</span><span class="s">&#39;fill_oi&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="s">&#39;NaN&#39;</span><span class="p">)),</span>
              <span class="p">(</span><span class="s">&#39;skip_first_fill&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>

    <span class="c"># Minimum delta unit in between bars</span>
    <span class="n">_tdeltas</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">TimeFrame</span><span class="o">.</span><span class="n">Minutes</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">60</span><span class="p">),</span>
        <span class="n">TimeFrame</span><span class="o">.</span><span class="n">Seconds</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
        <span class="n">TimeFrame</span><span class="o">.</span><span class="n">MicroSeconds</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">microseconds</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c"># Calculate and save timedelta for timeframe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tdunit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tdeltas</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">_timeframe</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">_compression</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seenbar</span> <span class="o">=</span> <span class="bp">False</span>  <span class="c"># control if at least one bar has been seen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sessend</span> <span class="o">=</span> <span class="n">MAXDATE</span>  <span class="c"># maxdate is the control for bar in session</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Params:</span>
<span class="sd">          - data: the data source to filter/process</span>

<span class="sd">        Returns:</span>
<span class="sd">          - False (always) because this filter does not remove bars from the</span>
<span class="sd">        stream</span>

<span class="sd">        The logic (starting with a session end control flag of MAXDATE)</span>

<span class="sd">          - If new bar is over session end (never true for 1st bar)</span>

<span class="sd">            Fill up to session end. Reset sessionend to MAXDATE &amp; fall through</span>

<span class="sd">          - If session end is flagged as MAXDATE</span>

<span class="sd">            Recalculate session limits and check whether the bar is within them</span>

<span class="sd">            if so, fill up and record the last seen tim</span>

<span class="sd">          - Else ... the incoming bar is in the session, fill up to it</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Get time of current (from data source) bar</span>
        <span class="n">dtime_cur</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">dtime_cur</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessend</span><span class="p">:</span>
            <span class="c"># bar over session end - fill up and invalidate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fillbars</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtime_prev</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessend</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tdunit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessend</span> <span class="o">=</span> <span class="n">MAXDATE</span>

        <span class="c"># Fall through from previous check ... the bar which is over the</span>
        <span class="c"># session could already be in a new session and within the limits</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sessend</span> <span class="o">==</span> <span class="n">MAXDATE</span><span class="p">:</span>
            <span class="c"># No bar seen yet or one went over previous session limit</span>
            <span class="n">sessstart</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">tm2datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sessionstart</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sessend</span> <span class="o">=</span> <span class="n">sessend</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">tm2datetime</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">sessionend</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">sessstart</span> <span class="o">&lt;=</span> <span class="n">dtime_cur</span> <span class="o">&lt;=</span> <span class="n">sessend</span><span class="p">:</span>
                <span class="c"># 1st bar from session in the session - fill from session start</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seenbar</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">skip_first_fill</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fillbars</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sessstart</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tdunit</span><span class="p">,</span> <span class="n">dtime_cur</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">seenbar</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtime_prev</span> <span class="o">=</span> <span class="n">dtime_cur</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c"># Seen a previous bar and this is in the session - fill up to it</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_fillbars</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dtime_prev</span><span class="p">,</span> <span class="n">dtime_cur</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtime_prev</span> <span class="o">=</span> <span class="n">dtime_cur</span>

        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_fillbars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">time_start</span><span class="p">,</span> <span class="n">time_end</span><span class="p">,</span> <span class="n">forcedirty</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Fills one by one bars as needed from time_start to time_end</span>

<span class="sd">        Invalidates the control dtime_prev if requested</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c"># Control flag - bars added to the stack</span>
        <span class="n">dirty</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="n">time_start</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tdunit</span>
        <span class="k">while</span> <span class="n">time_start</span> <span class="o">&lt;</span> <span class="n">time_end</span><span class="p">:</span>
            <span class="n">dirty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillbar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">time_start</span><span class="p">)</span>
            <span class="n">time_start</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tdunit</span>

        <span class="k">if</span> <span class="n">dirty</span> <span class="ow">or</span> <span class="n">forcedirty</span><span class="p">:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">_save2stack</span><span class="p">(</span><span class="n">erase</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_fillbar</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dtime</span><span class="p">):</span>
        <span class="c"># Prepare an array of the needed size</span>
        <span class="n">bar</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="s">&#39;Nan&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">()</span>

        <span class="c"># Fill datetime</span>
        <span class="n">bar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span><span class="p">]</span> <span class="o">=</span> <span class="n">date2num</span><span class="p">(</span><span class="n">dtime</span><span class="p">)</span>

        <span class="c"># Fill the prices</span>
        <span class="n">price</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">fill_price</span> <span class="ow">or</span> <span class="n">data</span><span class="o">.</span><span class="n">close</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">pricetype</span> <span class="ow">in</span> <span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Open</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">High</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Low</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">Close</span><span class="p">]:</span>
            <span class="n">bar</span><span class="p">[</span><span class="n">pricetype</span><span class="p">]</span> <span class="o">=</span> <span class="n">price</span>

        <span class="c"># Fill volume and open interest</span>
        <span class="n">bar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">Volume</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">fill_vol</span>
        <span class="n">bar</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">OpenInterest</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">p</span><span class="o">.</span><span class="n">fill_oi</span>

        <span class="c"># Fill extra lines the data feed may have defined beyond DateTime</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">DateTime</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="p">()):</span>
            <span class="n">bar</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="c"># Add tot he stack of bars to save</span>
        <span class="n">data</span><span class="o">.</span><span class="n">_add2stack</span><span class="p">(</span><span class="n">bar</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">True</span>
</pre></div>
</div>
</div>
</div>
</div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  
  <a href="../../2015-11-20-commission-schemes-subclassing/commission-schemes-subclassing/">
    <i class="fa fa-arrow-circle-left"></i>
    User Defined Commissions
  </a>
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'backtrader'; // required: replace example with your forum shortname
        var disqus_identifier = '/posts/2015-11-21-data-filters/data-filling-filtering/';
        var disqus_title = 'Data Filters';
        var disqus_url = 'http://www.backtrader.com/posts/2015-11-21-data-filters/data-filling-filtering';
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../">backtrader</a></h1>





<p>
<iframe src="https://ghbtns.com/github-btn.html?user=mementum&repo=backtrader&type=watch&count=true&size=large"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>




    

<p>
<a href="https://travis-ci.org/mementum/backtrader">
    <img
        alt="https://secure.travis-ci.org/mementum/backtrader.png?branch=master"
        src="https://secure.travis-ci.org/mementum/backtrader.png?branch=master"
    >
</a>
</p>

  
  
  <h2>
  
  <i class="fa fa-calendar"></i>
    Nov 21, 2015
  
  </h2>

  <ul>
    

  
  <li><i class="fa-fw fa fa-user"></i>
    
      
      <a href="../../../blog/author/mementum/">mementum</a>
      
    </li>
  

  

  

  

  
  
  <li>
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'backtrader'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    <i class="fa-fw fa fa-comments"></i>
    <a href="#disqus_thread" data-disqus-identifier="/posts/2015-11-21-data-filters/data-filling-filtering/"> </a>
  </li>
  
  </ul>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../about/">About backtrader</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about/#documentation">Documentation</a></li>
</ul>


  <h3><a href="../../../blog/">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="../../2015-11-20-commission-schemes-subclassing/commission-schemes-subclassing/">Nov 20 - User Defined Commissions</a></li>
    
      <li><a href="../../2015-11-05-commission-schemes-extended/commission-schemes-extended/">Nov 05 - Extending Commissions</a></li>
    
      <li><a href="../../2015-10-05-multitrades/multitrades/">Oct 05 - MultiTrades</a></li>
    
      <li><a href="../../2015-10-04-bar-synchronization/bar-synchronization/">Oct 04 - Bar Synchronization</a></li>
    
      <li><a href="../../2015-09-25-tickdata-resample/resample-tickdata/">Sep 25 - Tick Data and Resampling</a></li>
    
  </ul>

  <h3><a href="../../../blog/archive/">Archives</a></h3>
  <ul>
  
    
    <li><a href="../../../blog/2015/">2015 (27)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search/" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, mementum.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.6</a>
      
      |
      <a href="../../../_sources/posts/2015-11-21-data-filters/data-filling-filtering.txt"
          rel="nofollow">Page source</a>
    </div>

    
    <a href="https://github.com/mementum/backtrader" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
    <script type="text/javascript">

      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-2435868-6']);
      _gaq.push(['_setDomainName', 'none']);
      _gaq.push(['_setAllowLinker', true]);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();

    </script>
    
  </body>
</html>